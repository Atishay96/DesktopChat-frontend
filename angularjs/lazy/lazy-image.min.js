angular.module("afkl.lazyImage",[]),angular.module("afkl.lazyImage").service("afklSrcSetService",["$window","$timeout",function(a,b){"use strict";function c(a){this.src=a.src,this.w=a.w||1/0,this.h=a.h||1/0,this.x=a.x||1}function d(a,c){var d=!1;return function(){d||(a(),d=!0,b(function(){d=!1},c))}}var e=/^[0-9]+$/,f=function(a){for(var b=a.split(/\s/),c={},d=0,f=b.length;f>d;d++){var g=b[d];if(g.length>0){var h=g.slice(-1),i=g.substring(0,g.length-1),j=parseInt(i,10),k=parseFloat(i);i.match(e)&&"w"===h?c[h]=j:i.match(e)&&"h"===h?c[h]=j:isNaN(k)||"x"!==h||(c[h]=k)}}return c},g=function(a,b){for(var c=a[0],d=0,e=a.length;e>d;d++){var f=a[d];b(f,c)&&(c=f)}return c},h=function(a,b){for(var c=a.length-1;c>=0;c--){var d=a[c];b(d)&&a.splice(c,1)}return a},i=function(b,c){if(b){c||(c={w:a.innerWidth||document.documentElement.clientWidth,h:a.innerHeight||document.documentElement.clientHeight,x:a.devicePixelRatio||1});var d=b.slice(0),e=g(d,function(a,b){return a.w>b.w});h(d,function(){return function(a){return a.w<c.w}}(this)),0===d.length&&(d=[e]);var f=g(d,function(a,b){return a.h>b.h});h(d,function(){return function(a){return a.h<c.h}}(this)),0===d.length&&(d=[f]);var i=g(d,function(a,b){return a.x>b.x});h(d,function(){return function(a){return a.x<c.x}}(this)),0===d.length&&(d=[i]);var j=g(d,function(a,b){return a.w<b.w});h(d,function(a){return a.w>j.w});var k=g(d,function(a,b){return a.h<b.h});h(d,function(a){return a.h>k.h});var l=g(d,function(a,b){return a.x<b.x});return h(d,function(a){return a.x>l.x}),d[0]}},j=function(a){var b=[],d=a.src,e=a.srcset;if(e){var g=function(a){for(var c=0,d=b.length;d>c;c++){var e=b[c];if(e.x===a.x&&e.w===a.w&&e.h===a.h)return}b.push(a)},h=function(){for(var a,b,h=e,i=0,j=[];""!==h;){for(;" "===h.charAt(0);)h=h.slice(1);i=h.indexOf(" "),-1!==i?(a=h.slice(0,i),h=h.slice(i+1),i=h.indexOf(","),-1===i?(b=h,h=""):(b=h.slice(0,i),h=h.slice(i+1)),j.push({url:a,descriptors:b})):(j.push({url:h,descriptors:""}),h="")}for(var k=0,l=j.length;l>k;k++){var m=j[k],n=f(m.descriptors);g(new c({src:m.url,x:n.x,w:n.w,h:n.h}))}d&&g(new c({src:d}))};h();var j=i(b),k={best:j,candidates:b};return b=null,k}};return{get:j,image:i,debounce:d}}]),angular.module("afkl.lazyImage").directive("afklImageContainer",function(){"use strict";return{restrict:"A",controller:["$scope","$element",function(a,b){b.data("afklImageContainer",b)}]}}).directive("afklLazyImage",["$rootScope","$window","$timeout","afklSrcSetService","$parse",function(a,b,c,d,e){"use strict";var f=function(a){var b,c=d.get({srcset:a});return c&&(b=c.best.src),b};return{restrict:"A",link:function(g,h,i){var j=function(a){var b=[];return o.imgAttrs&&(b=Array.prototype.map.call(a,function(a){for(var b in a)if(a.hasOwnProperty(b))return String.prototype.concat.call(b,'="',a[b],'"')})),b.join(" ")},k=h.inheritedData("afklImageContainer");k||(k=angular.element(i.afklLazyImageContainer||b));var l,m=!1,n=i.afklLazyImage,o=i.afklLazyImageOptions?e(i.afklLazyImageOptions)(g):{},p=null,q=null,r=o.offset?o.offset:50,s=j(o.imgAttrs),t="afkl-lazy-image-loading";i.afklLazyImageLoaded=!1;var u=function(){if(k.scrollTop){var a=k.scrollTop();if(a)return a}var b=k[0];return void 0!==b.pageYOffset?b.pageYOffset:void 0!==b.scrollTop?b.scrollTop:document.documentElement.scrollTop||0},v=function(){if(k.innerHeight)return k.innerHeight();var a=k[0];return void 0!==a.innerHeight?a.innerHeight:void 0!==a.clientHeight?a.clientHeight:document.documentElement.clientHeight||0},w=function(){if(h.offset)return h.offset().top;var a=h[0].getBoundingClientRect();return a.top+u()-document.documentElement.clientTop},x=function(){return h.offset?h.offset().top-k.offset().top:h[0].getBoundingClientRect().top-k[0].getBoundingClientRect().top},y=function(){o.background?h[0].style.backgroundImage='url("'+q+'")':p&&(p[0].src=q)},z=function(){m=!0;var a=f(n);a&&(o.background||p||(h.addClass(t),p=angular.element("<img "+s+" />"),p.one("load",B),p.one("error",C),h.append(p)),A()),k.off("scroll",D)},A=function(){if(m){var a=f(n);a!==q&&(q=a,y())}};A();var B=function(){i.$set("afklLazyImageLoaded","done"),h.removeClass(t)},C=function(){i.$set("afklLazyImageLoaded","fail")},D=function(){if(!m){var a,c,d,e=v(),f=u(),g=k[0]===b?w():x();d=k[0]===b?e+f:e,a=g-d,c=r>=a,c&&z()}},E=d.debounce(D,300),F=function(){c.cancel(l),l=c(function(){A(),D()},300)},G=function(){c.cancel(l),angular.element(b).off("resize",F),angular.element(b).off("scroll",E),k[0]!==b&&(k.off("resize",F),k.off("scroll",E)),p&&p.remove(),p=l=q=void 0};return angular.element(b).on("resize",F),angular.element(b).on("scroll",E),k[0]!==b&&(k.on("resize",F),k.on("scroll",E)),i.$observe("afklLazyImage",function(){n=i.afklLazyImage,m&&z()}),o.nolazy&&z(),g.$on("afkl.lazyImage.destroyed",F),g.$on("$destroy",function(){return a.$broadcast("afkl.lazyImage.destroyed"),G()}),D()}}}]);